<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>IP Âú∞ÂùÄÂàÜÂ∏É‚ÄîÂõæË°® + Âú∞Âõæ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Leaflet CSS/JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <!-- ECharts -->
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.0.2/echarts.common.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        body {
            background: #0a192f;
            color: #ccd6f6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .chart-container {
            background: rgba(17, 34, 64, 0.8);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chart-title {
            font-size: 24px;
            font-weight: 600;
            color: #64ffda;
            margin-bottom: 20px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .chart-wrapper {
            height: 60vh;
            min-height: 300px;
            margin-bottom: 10px;
        }

        #world-chart,
        #china-chart,
        #world-map,
        #china-map {
            width: 100% !important;
            height: 100% !important;
        }

        .map {
            height: 400px;
            border-radius: 10px;
        }

        @media (max-width: 768px) {
            .chart-wrapper {
                height: 50vh;
                min-height: 200px;
            }

            .chart-title {
                font-size: 20px;
            }

            .container {
                padding: 10px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- ÂÖ®ÁêÉ -->
        <div class="chart-container">
            <div class="chart-title">üåç Global IP Distribution</div>
            <div class="chart-wrapper">
                <div id="world-chart"></div>
            </div>
            <div class="chart-wrapper map">
                <div id="world-map"></div>
            </div>
        </div>

        <!-- ‰∏≠ÂõΩ -->
        <div class="chart-container">
            <div class="chart-title">üá®üá≥ China IP Distribution</div>
            <div class="chart-wrapper">
                <div id="china-chart"></div>
            </div>
            <div class="chart-wrapper map">
                <div id="china-map"></div>
            </div>
        </div>
    </div>

    <script>
        // 1. ÈÄöÁî® ECharts ÈÖçÁΩÆÂ∑•ÂéÇ
        const createChartOption = (title) => ({
            title: {
                text: title,
                textStyle: { color: '#64ffda', fontSize: 18, fontWeight: 'bold' },
                left: 'center'
            },
            grid: { containLabel: true, top: '10%', left: '5%', right: '5%', bottom: '15%' },
            tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'shadow' },
                backgroundColor: 'rgba(17,34,64,0.95)',
                borderColor: '#64ffda',
                textStyle: { color: '#ccd6f6' }
            },
            xAxis: {
                type: 'category',
                axisLabel: { color: '#8892b0', rotate: 45, fontSize: 12 },
                axisLine: { lineStyle: { color: '#233554' } }
            },
            yAxis: {
                type: 'value',
                axisLabel: { color: '#8892b0', fontSize: 12 },
                axisLine: { lineStyle: { color: '#233554' } },
                splitLine: { lineStyle: { color: '#233554' } }
            },
            dataZoom: [{
                type: 'slider',
                show: true,
                xAxisIndex: 0,
                height: 20,
                bottom: 30,
                fillerColor: 'rgba(100,255,218,0.2)',
                borderColor: 'transparent',
                textStyle: { color: '#ccd6f6' }
            }],
            series: [{
                type: 'bar',
                barWidth: '60%',
                itemStyle: {
                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                        { offset: 0, color: '#64ffda' },
                        { offset: 1, color: '#233554' }
                    ]),
                    shadowColor: 'rgba(100,255,218,0.5)',
                    shadowBlur: 10
                },
                emphasis: {
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: '#64ffda' },
                            { offset: 1, color: '#64ffda' }
                        ])
                    }
                }
            }]
        });

        // 2. ÂàùÂßãÂåñÂõæË°®
        const worldChart = echarts.init(document.getElementById('world-chart'));
        const chinaChart = echarts.init(document.getElementById('china-chart'));
        worldChart.setOption(createChartOption('Global IP Distribution'));
        chinaChart.setOption(createChartOption('China IP Distribution'));

        // 3. ÂàùÂßãÂåñ Leaflet Âú∞Âõæ
        const worldMap = L.map('world-map').setView([20, 0], 2);
        const chinaMap = L.map('china-map').setView([35, 105], 4);
        const tileURL = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        L.tileLayer(tileURL, { attribution: '&copy; OpenStreetMap contributors' }).addTo(worldMap);
        L.tileLayer(tileURL, { attribution: '&copy; OpenStreetMap contributors' }).addTo(chinaMap);

        // 4. Á§∫‰æãÂùêÊ†áÔºàÂèØÊâ©Â±ïÊàñÊîπ‰∏∫Âä®ÊÄÅÂú∞ÁêÜÁºñÁ†ÅÔºâ
        const worldCoordinates = {
            "United States": [37.0902, -95.7129],
            "Canada": [56.1304, -106.3468],
            "United Kingdom": [55.3781, -3.4360],
            "France": [46.2276, 2.2137],
            "Germany": [51.1657, 10.4515],
            "Brazil": [-14.2350, -51.9253],
            "India": [20.5937, 78.9629],
            "Australia": [-25.2744, 133.7751],
            "Russia": [61.5240, 105.3188],
            "Japan": [36.2048, 138.2529],
            "South Africa": [-30.5595, 22.9375],
            "Mexico": [23.6345, -102.5528],
            "Argentina": [-38.4161, -63.6167],
            "Egypt": [26.8206, 30.8025],
            "Indonesia": [-0.7893, 113.9213]
        };

        const chinaCoordinates = {
            "Beijing": [39.9042, 116.4074],
            "Shanghai": [31.2304, 121.4737],
            "Guangzhou": [23.1291, 113.2644],
            "Shenzhen": [22.5431, 114.0579],
            "Chengdu": [30.5728, 104.0668],
            "Chongqing": [29.4316, 106.9123],
            "Hangzhou": [30.2741, 120.1551],
            "Wuhan": [30.5928, 114.3055],
            "Xi'an": [34.3416, 108.9398],
            "Tianjin": [39.3434, 117.3616],
            "Nanjing": [32.0603, 118.7969],
            "Suzhou": [31.2989, 120.5853],
            "Shenyang": [41.8057, 123.4315],
            "Harbin": [45.8038, 126.5349],
            "Chongqing": [29.4316, 106.9123]  // Â∑≤Âê´ÔºåÂèØÊ†πÊçÆÈúÄÊ±ÇÂ¢ûÂáè
        };

        // 5. Âä†ËΩΩÊï∞ÊçÆÔºåÊ∏≤ÊüìÂõæË°®Âπ∂ÊâìÁÇπ
        Promise.all([
            fetch('get_world_data/').then(r => r.json()),
            fetch('get_china_data/').then(r => r.json())
        ]).then(([worldData, chinaData]) => {
            // ÂÖ®ÁêÉ
            if (worldData.status) {
                const { countries, counts } = worldData.data;
                worldChart.setOption({ xAxis: { data: countries }, series: [{ data: counts }] });
                countries.forEach((c, i) => {
                    const coord = worldCoordinates[c];
                    if (coord) {
                        L.marker(coord).addTo(worldMap)
                            .bindPopup(`<b>${c}</b><br>IP Êï∞Èáè: ${counts[i]}`);
                    }
                });
            }

            // ‰∏≠ÂõΩ
            if (chinaData.status) {
                const { cities, counts } = chinaData.data;
                chinaChart.setOption({ xAxis: { data: cities }, series: [{ data: counts }] });
                cities.forEach((city, i) => {
                    const coord = chinaCoordinates[city];
                    if (coord) {
                        L.marker(coord).addTo(chinaMap)
                            .bindPopup(`<b>${city}</b><br>IP Êï∞Èáè: ${counts[i]}`);
                    }
                });
            }
        });

        // 6. Á™óÂè£Â∞∫ÂØ∏ÂèòÂåñÊó∂ÂêåÊ≠•ÈáçÁªò
        window.addEventListener('resize', () => {
            worldChart.resize();
            chinaChart.resize();
            worldMap.invalidateSize();
            chinaMap.invalidateSize();
        });
    </script>
</body>

</html>
